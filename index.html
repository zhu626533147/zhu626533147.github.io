<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作组 - 验证码验证</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入腾讯云开发SDK -->
    <script src="https://web.sdk.qcloud.com/cloudbase/1.10.0/cloudbase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .record-item { @apply bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-3 transition-all hover:shadow-md; }
            .input-container { @apply bg-white p-4 rounded-lg shadow-md border border-gray-200; }
            .verify-container { @apply bg-white p-8 rounded-xl shadow-lg border border-gray-200 max-w-md mx-auto mt-20; }
            .admin-btn { @apply transition-all hover:opacity-80 cursor-pointer; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- 验证码验证区域 -->
    <div id="verifySection" class="container mx-auto px-4 py-8">
        <div class="verify-container">
            <div class="text-center mb-6">
                <i class="fa fa-lock text-4xl text-primary mb-3"></i>
                <h2 class="text-2xl font-bold text-gray-800">请输入四位验证码</h2>
                <p class="text-secondary mt-2">相同验证码的用户共享记录<br>第一个输入者为管理员（可删除记录）</p>
            </div>
            <div class="flex flex-col gap-4">
                <input 
                    type="text" 
                    id="verifyCode" 
                    maxlength="4"
                    inputmode="numeric"
                    pattern="[0-9]{4}"
                    class="border border-gray-300 rounded-lg p-4 text-center text-2xl font-medium focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    placeholder="1234">
                <div id="verifyError" class="text-red-500 text-sm hidden text-center">请输入有效的四位数字验证码</div>
                <button id="verifyBtn" class="bg-primary hover:bg-primary/90 text-white py-3 px-6 rounded-lg font-medium transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fa fa-unlock-alt"></i>
                    <span>验证并进入</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div id="mainSection" class="container mx-auto px-4 py-8 max-w-3xl hidden">
        <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] text-gray-800 mb-2">工作组</h1>
                <p class="text-secondary">
                    当前分组：<span id="currentCode" class="font-medium text-primary"></span>
                    <span id="adminTag" class="ml-2 px-2 py-1 bg-primary/10 text-primary text-xs rounded-full hidden">
                        <i class="fa fa-shield mr-1"></i>管理员
                    </span>
                </p>
            </div>
            <div class="flex gap-3">
                <button id="clearAllBtn" class="hidden bg-danger hover:bg-danger/90 text-white py-2 px-4 rounded-lg font-medium text-sm transition-all flex items-center justify-center gap-1 shadow-md hover:shadow-lg">
                    <i class="fa fa-trash"></i>
                    <span>清空全部</span>
                </button>
                <button id="logoutBtn" class="text-sm text-gray-600 hover:text-primary flex items-center gap-1">
                    <i class="fa fa-sign-out"></i>
                    <span>退出分组</span>
                </button>
            </div>
        </header>

        <section class="input-container mb-8">
            <div class="flex flex-col gap-4">
                <label for="contentInput" class="text-gray-700 font-medium">输入内容：</label>
                <textarea 
                    id="contentInput" 
                    rows="4" 
                    class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all resize-none"
                    placeholder="请输入消息内容..."></textarea>
                <button id="submitBtn" class="bg-primary hover:bg-primary/90 text-white py-3 px-6 rounded-lg font-medium transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fa fa-paper-plane"></i>
                    <span>发送消息</span>
                </button>
            </div>
        </section>

        <section class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">工作组记录</h2>
                <span id="recordCount" class="text-sm text-secondary">0 条记录</span>
            </div>
            <div id="recordsContainer" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 content-auto">
                <div id="emptyState" class="text-center py-12 text-secondary">
                    <i class="fa fa-comment-o text-4xl mb-3 opacity-50"></i>
                    <p>暂无工作组记录，快来发送第一条消息吧！</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // ========== 腾讯云开发初始化 ==========
        let app, db, workgroupsCollection;
        
        try {
            // 检查cloudbase对象是否存在
            if (typeof cloudbase === 'undefined') {
                throw new Error('腾讯云开发SDK未加载成功');
            }
            
            app = cloudbase.init({
                env: "workgroup-chat-6gb3mguae5c384e1" // 替换为你的环境ID
            });
            
            console.log('云开发SDK初始化成功');
            
            // 匿名登录（无需用户注册，直接访问数据库）
            app.auth({ persistence: "local" }).anonymousAuthProvider().signIn().then(() => {
                console.log("云开发匿名登录成功");
                // 登录成功后初始化数据库
                db = app.database();
                workgroupsCollection = db.collection("workgroups"); // 集合名称
                console.log('数据库连接成功');
            }).catch(err => {
                console.error("云开发登录失败：", err);
                alert("云数据库登录失败，请检查网络连接并刷新页面重试。错误：" + (err.message || JSON.stringify(err)));
            });
        } catch (err) {
            console.error("云开发初始化失败：", err);
            alert("云开发SDK初始化失败，请检查网络连接或稍后重试。错误：" + (err.message || JSON.stringify(err)));
        }

        // ========== 核心变量 ==========
        const verifySection = document.getElementById('verifySection');
        const verifyCodeInput = document.getElementById('verifyCode');
        const verifyBtn = document.getElementById('verifyBtn');
        const verifyError = document.getElementById('verifyError');
        const mainSection = document.getElementById('mainSection');
        const currentCodeEl = document.getElementById('currentCode');
        const adminTag = document.getElementById('adminTag');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const contentInput = document.getElementById('contentInput');
        const submitBtn = document.getElementById('submitBtn');
        const recordsContainer = document.getElementById('recordsContainer');
        const emptyState = document.getElementById('emptyState');
        const recordCount = document.getElementById('recordCount');

        let currentVerifyCode = '';
        let isAdmin = false;
        let groupData = { records: [], adminCreated: false, lastClearTime: Date.now() };
        const ONE_DAY_MS = 86400000; // 24小时毫秒数

        // ========== 核心方法（替换为云数据库操作） ==========
        // 验证验证码
        const validateCode = (code) => /^\d{4}$/.test(code.trim());

        // 获取分组数据（从云数据库读取）
        const getGroupData = async (code) => {
            try {
                // 检查数据库是否初始化
                if (!workgroupsCollection) {
                    throw new Error('数据库未初始化，请确保云开发SDK加载成功');
                }
                
                // 查询验证码对应的分组
                const res = await workgroupsCollection.where({ code: code }).get();
                console.log('获取分组数据成功:', res.data);
                
                if (res.data.length === 0) {
                    // 无数据则返回默认值
                    return { records: [], adminCreated: false, lastClearTime: Date.now(), code: code };
                }
                // 有数据则返回，兼容lastClearTime字段
                const group = res.data[0];
                if (!group.lastClearTime) group.lastClearTime = Date.now();
                return group;
            } catch (e) {
                console.error('读取云数据失败:', e);
                alert('读取数据库失败：' + (e.message || JSON.stringify(e)));
                return { records: [], adminCreated: false, lastClearTime: Date.now(), code: code };
            }
        };

        // 保存分组数据（写入云数据库）
        const saveGroupData = async (code, data) => {
            try {
                // 检查数据库是否初始化
                if (!workgroupsCollection) {
                    throw new Error('数据库未初始化，请确保云开发SDK加载成功');
                }
                
                // 先查是否存在该分组
                const res = await workgroupsCollection.where({ code: code }).get();
                
                if (res.data.length === 0) {
                    // 新增分组
                    await workgroupsCollection.add(data);
                    console.log('新增分组成功:', data);
                } else {
                    // 更新已有分组
                    await workgroupsCollection.doc(res.data[0]._id).update(data);
                    console.log('更新分组成功:', data);
                }
            } catch (e) {
                console.error('保存云数据失败:', e);
                alert("消息保存失败，请重试。错误：" + (e.message || JSON.stringify(e)));
            }
        };

        // 检查是否需要24小时自动清空
        const checkAutoClear = async () => {
            if (!currentVerifyCode || groupData.records.length === 0) return;

            const now = Date.now();
            if (now - groupData.lastClearTime >= ONE_DAY_MS) {
                groupData.records = [];
                groupData.lastClearTime = now;
                await saveGroupData(currentVerifyCode, groupData);
                recordsContainer.innerHTML = '';
                recordsContainer.appendChild(emptyState);
                updateCount();
                showToast('工作组记录已超过24小时，已自动清空', 'warning');
                console.log('自动清空工作组记录：超过24小时未清空');
            }
        };

        // 更新清空按钮状态
        const updateClearBtn = () => {
            if (!isAdmin) {
                clearAllBtn.classList.add('hidden');
                return;
            }
            clearAllBtn.classList.toggle('hidden', groupData.records.length === 0);
        };

        // 更新计数和空状态
        const updateCount = () => {
            recordCount.textContent = `${groupData.records.length} 条记录`;
            emptyState.style.display = groupData.records.length > 0 ? 'none' : 'block';
            updateClearBtn();
        };

        // 渲染记录
        const renderRecords = () => {
            recordsContainer.innerHTML = '';
            if (groupData.records.length === 0) {
                recordsContainer.appendChild(emptyState);
                updateCount();
                return;
            }

            groupData.records.slice().reverse().forEach((record, index) => {
                const item = document.createElement('div');
                item.className = 'record-item';
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm text-gray-500"><i class="fa fa-clock-o mr-1"></i>${record.time}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">#${groupData.records.length - index}</span>
                            ${isAdmin ? `<span class="admin-btn text-danger text-xs" onclick="deleteSingleRecord(${record.timestamp})"><i class="fa fa-times-circle"></i> 删除</span>` : ''}
                        </div>
                    </div>
                    <p class="text-gray-800 whitespace-pre-wrap">${record.content}</p>
                `;
                recordsContainer.appendChild(item);
            });

            updateCount();
        };

        // 删除单条记录
        const deleteSingleRecord = async (timestamp) => {
            if (!isAdmin) return;
            groupData.records = groupData.records.filter(r => r.timestamp !== timestamp);
            await saveGroupData(currentVerifyCode, groupData);
            renderRecords();
            showToast('消息删除成功');
        };

        // 手动清空全部记录
        const clearAllRecords = async () => {
            if (!isAdmin) {
                showToast('非管理员无清空权限', 'error');
                return;
            }
            if (groupData.records.length === 0) {
                showToast('暂无记录可清空', 'warning');
                return;
            }
            if (!confirm('确定要清空全部工作组记录吗？此操作不可恢复！')) return;

            groupData.records = [];
            groupData.lastClearTime = Date.now();
            await saveGroupData(currentVerifyCode, groupData);
            groupData = await getGroupData(currentVerifyCode);
            recordsContainer.innerHTML = '';
            recordsContainer.appendChild(emptyState);
            updateCount();
            showToast('全部工作组记录已清空');
            console.log('手动清空后云数据:', await getGroupData(currentVerifyCode));
        };

        // 提交消息
        const submitMessage = async () => {
            const content = contentInput.value.trim();
            if (!content) {
                contentInput.classList.add('border-red-500');
                setTimeout(() => contentInput.classList.remove('border-red-500'), 2000);
                return;
            }

            const now = new Date();
            const newRecord = {
                content,
                time: now.toLocaleString('zh-CN'),
                timestamp: now.getTime()
            };

            groupData.records.push(newRecord);
            await saveGroupData(currentVerifyCode, groupData);
            contentInput.value = '';
            renderRecords();
            submitBtn.classList.add('bg-green-600');
            submitBtn.innerHTML = '<i class="fa fa-check"></i><span>发送成功</span>';
            setTimeout(() => {
                submitBtn.classList.remove('bg-green-600');
                submitBtn.innerHTML = '<i class="fa fa-paper-plane"></i><span>发送消息</span>';
            }, 1500);
            contentInput.focus();
        };

        // 进入工作组
        const enterWorkgroup = async (code) => {
            currentVerifyCode = code;
            groupData = await getGroupData(code);
            isAdmin = !groupData.adminCreated;

            // 标记管理员已创建
            if (isAdmin) {
                groupData.adminCreated = true;
                await saveGroupData(code, groupData);
            }

            // 检查自动清空
            await checkAutoClear();

            // 存储会话状态
            sessionStorage.setItem('workgroup_code', code);
            sessionStorage.setItem('workgroup_admin', isAdmin);

            // 更新UI
            verifySection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            currentCodeEl.textContent = code;
            adminTag.classList.toggle('hidden', !isAdmin);
            updateClearBtn();
            renderRecords();
            contentInput.focus();
        };

        // 退出工作组
        const logoutWorkgroup = () => {
            sessionStorage.removeItem('workgroup_code');
            sessionStorage.removeItem('workgroup_admin');
            currentVerifyCode = '';
            isAdmin = false;
            groupData = { records: [], adminCreated: false, lastClearTime: Date.now() };
            mainSection.classList.add('hidden');
            verifySection.classList.remove('hidden');
            verifyCodeInput.value = '';
            verifyError.classList.add('hidden');
            adminTag.classList.add('hidden');
            clearAllBtn.classList.add('hidden');
        };

        // 显示提示框
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-500';
            toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 fixed top-4 right-4 transition-all duration-500`;
            toast.innerHTML = `<i class="fa fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'exclamation'} mr-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 2000);
        };

        // 定期刷新记录+检查自动清空
        const refreshRecords = async () => {
            if (!currentVerifyCode) return;
            
            try {
                await checkAutoClear();
                
                // 检查数据库是否初始化
                if (!workgroupsCollection) {
                    console.warn('数据库未初始化，跳过刷新记录');
                    return;
                }
                
                const latestData = await getGroupData(currentVerifyCode);
                if (JSON.stringify(latestData.records) !== JSON.stringify(groupData.records)) {
                    groupData.records = latestData.records;
                    groupData.lastClearTime = latestData.lastClearTime;
                    renderRecords();
                    console.log('记录刷新成功，当前记录数:', groupData.records.length);
                }
            } catch (e) {
                console.error('刷新记录失败:', e);
            }
        };

        // ========== 事件监听 ==========
        verifyBtn.addEventListener('click', async () => {
            const code = verifyCodeInput.value.trim();
            if (validateCode(code)) {
                verifyError.classList.add('hidden');
                await enterWorkgroup(code);
            } else {
                verifyError.classList.remove('hidden');
                verifyCodeInput.classList.add('border-red-500');
                setTimeout(() => verifyCodeInput.classList.remove('border-red-500'), 2000);
            }
        });

        verifyCodeInput.addEventListener('keydown', (e) => e.key === 'Enter' && verifyBtn.click());
        logoutBtn.addEventListener('click', logoutWorkgroup);
        submitBtn.addEventListener('click', submitMessage);
        clearAllBtn.addEventListener('click', clearAllRecords);
        contentInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitMessage();
            }
        });

        // 自适应文本框高度
        contentInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (Math.min(this.scrollHeight, 120)) + 'px';
        });

        // 暴露删除函数到全局
        window.deleteSingleRecord = deleteSingleRecord;

        // ========== 初始化 ==========
        // 定期刷新（1分钟一次）
        setInterval(refreshRecords, 60000);

        // 恢复会话状态 - 延迟执行，确保数据库初始化完成
        setTimeout(() => {
            const savedCode = sessionStorage.getItem('workgroup_code');
            const savedAdmin = sessionStorage.getItem('workgroup_admin') === 'true';
            if (savedCode && validateCode(savedCode)) {
                console.log('恢复会话状态，验证码:', savedCode, '是否管理员:', savedAdmin);
                enterWorkgroup(savedCode);
            }
        }, 1000); // 延迟1秒执行，确保云开发SDK初始化完成
    </script>
</body>
</html>
