<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作组</title>
    <style>
        /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        /* 标题样式 */
        .title {
            text-align: center;
            font-size: 28px;
            color: #333;
            margin-bottom: 30px;
            font-weight: bold;
        }

        /* 输入区域样式 */
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #message-input:focus {
            border-color: #1677ff;
        }

        #send-btn {
            padding: 0 20px;
            background-color: #1677ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #send-btn:hover {
            background-color: #0f62d9;
        }

        /* 历史记录区域样式 */
        .history-area {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .history-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        #history-list {
            list-style: none;
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 15px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .item-time {
            color: #999;
            font-size: 12px;
            margin-left: 10px;
        }

        /* 空状态样式 */
        .empty-tip {
            text-align: center;
            color: #999;
            padding: 30px 0;
            font-size: 15px;
        }
    </style>
</head>
<body>
    <h1 class="title">工作组</h1>

    <!-- 输入区域 -->
    <div class="input-area">
        <input type="text" id="message-input" placeholder="请输入内容...">
        <button id="send-btn">发送</button>
    </div>

    <!-- 历史记录区域 -->
    <div class="history-area">
        <div class="history-title">历史输入记录</div>
        <ul id="history-list"></ul>
    </div>

    <!-- 引入腾讯云开发SDK -->
    <script src="https://web.sdk.qcloud.com/cloudbase/1.10.0/cloudbase.js"></script>
    <script>
        // 初始化云开发环境
        const app = cloudbase.init({
            env: "workgroup-chat-6gb3mguae5c384e1" // 你的腾讯云环境ID
        });

        // 获取数据库引用
        const db = app.database();
        const collection = db.collection("workgroups");

        // DOM元素获取
        const messageInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const historyList = document.getElementById("history-list");

        // 格式化时间：YYYY-MM-DD HH:MM:SS
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
        }

        // 加载历史记录
        async function loadHistory() {
            try {
                // 查询数据库，按创建时间倒序排列（最新的在最上面）
                const res = await collection.orderBy("createTime", "desc").get();
                const messages = res.data;
                
                // 清空列表
                historyList.innerHTML = "";

                // 无记录时显示提示
                if (messages.length === 0) {
                    historyList.innerHTML = `<li class="empty-tip">暂无输入记录</li>`;
                    return;
                }

                // 渲染历史记录
                messages.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "history-item";
                    li.innerHTML = `${item.content} <span class="item-time">${formatTime(item.createTime)}</span>`;
                    historyList.appendChild(li);
                });
            } catch (err) {
                console.error("加载历史记录失败：", err);
                alert("加载历史记录失败，请刷新页面重试");
            }
        }

        // 发送消息
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) {
                alert("请输入内容后再发送");
                return;
            }

            try {
                // 写入数据库
                await collection.add({
                    content: content,
                    createTime: db.serverDate() // 使用服务器时间，避免客户端时间不一致
                });

                // 清空输入框
                messageInput.value = "";

                // 重新加载历史记录
                loadHistory();
            } catch (err) {
                console.error("发送消息失败：", err);
                alert("发送失败，请重试");
            }
        }

        // 页面加载完成后初始化
        window.onload = async function() {
            // 初始化云开发登录（匿名登录，无需账号）
            try {
                await app.auth().anonymousAuthProvider().signIn();
                console.log("匿名登录成功");
                // 加载历史记录
                loadHistory();

                // 监听发送按钮点击事件
                sendBtn.addEventListener("click", sendMessage);

                // 监听输入框回车事件
                messageInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        sendMessage();
                    }
                });

                // 实时监听数据库变化（可选：实现无刷新更新）
                collection.watch({
                    onChange: () => {
                        loadHistory(); // 数据变化时重新加载
                    },
                    onError: (err) => {
                        console.error("实时监听失败：", err);
                    }
                });
            } catch (err) {
                console.error("初始化失败：", err);
                alert("网站初始化失败，请检查网络或腾讯云环境配置");
            }
        };
    </script>
</body>
</html>
